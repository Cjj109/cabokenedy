---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getFlashPromo } from '../../lib/db';

const runtime = (Astro.locals as any).runtime;
const db = runtime?.env?.DB as D1Database;

const flash = await getFlashPromo(db);
---

<AdminLayout title="Promo Flash" activeSection="flash">
  <div class="mb-6">
    <h1 class="text-2xl font-heading font-bold">Promo Flash — Estrella Fugaz</h1>
    <p class="text-text-muted text-sm mt-1">Gestiona la promo flash especial</p>
  </div>

  {flash ? (
    <div class="admin-card p-6 max-w-xl">
      <!-- Active Toggle -->
      <div class="flex items-center justify-between mb-6 pb-4 border-b border-white/5">
        <div class="flex items-center gap-3">
          <span class="text-2xl">{flash.icon}</span>
          <div>
            <p class="font-bold">Estado de la Promo</p>
            <p class="text-text-muted text-xs" id="status-text">{flash.active ? 'Activa — visible en el sitio' : 'Inactiva — oculta del sitio'}</p>
          </div>
        </div>
        <div class={`admin-toggle ${flash.active ? 'active' : ''}`} id="flash-toggle"></div>
      </div>

      <!-- Edit Form -->
      <form id="flash-form" class="space-y-4">
        <div>
          <label class="block text-text-secondary text-xs font-medium mb-1.5">Nombre</label>
          <input type="text" id="ff-name" class="admin-input" value={flash.name} maxlength="200" />
        </div>
        <div>
          <label class="block text-text-secondary text-xs font-medium mb-1.5">Descripción</label>
          <textarea id="ff-desc" class="admin-input" rows="2" maxlength="500">{flash.description}</textarea>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-text-secondary text-xs font-medium mb-1.5">Precio USD</label>
            <input type="number" id="ff-price" class="admin-input" value={flash.price_usd} min="0" max="9999" step="0.01" />
          </div>
          <div>
            <label class="block text-text-secondary text-xs font-medium mb-1.5">Disponibilidad</label>
            <input type="text" id="ff-avail" class="admin-input" value={flash.availability} maxlength="100" />
          </div>
        </div>
        <div>
          <label class="block text-text-secondary text-xs font-medium mb-1.5">Canales</label>
          <input type="text" id="ff-channels" class="admin-input" value={flash.channels} maxlength="200" />
        </div>

        <div class="flex items-center gap-3 pt-2">
          <button type="submit" class="admin-btn admin-btn-primary">Guardar Cambios</button>
          <span class="save-indicator" id="flash-saved">Guardado</span>
        </div>
      </form>
    </div>
  ) : (
    <div class="admin-card p-8 text-center max-w-md mx-auto">
      <p class="text-text-muted">No hay promo flash configurada en la base de datos.</p>
    </div>
  )}

  <script>
    // Toggle active state
    const toggle = document.getElementById('flash-toggle');
    let isActive = toggle?.classList.contains('active') ?? false;

    toggle?.addEventListener('click', async () => {
      isActive = !isActive;
      const res = await fetch('/api/admin/flash-promo', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ active: isActive }),
      });
      if (res.ok) {
        toggle.classList.toggle('active', isActive);
        const statusText = document.getElementById('status-text');
        if (statusText) {
          statusText.textContent = isActive ? 'Activa — visible en el sitio' : 'Inactiva — oculta del sitio';
        }
      }
    });

    // Form submit
    document.getElementById('flash-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const res = await fetch('/api/admin/flash-promo', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: (document.getElementById('ff-name') as HTMLInputElement).value.trim(),
          description: (document.getElementById('ff-desc') as HTMLTextAreaElement).value.trim(),
          price_usd: parseFloat((document.getElementById('ff-price') as HTMLInputElement).value),
          availability: (document.getElementById('ff-avail') as HTMLInputElement).value.trim(),
          channels: (document.getElementById('ff-channels') as HTMLInputElement).value.trim(),
        }),
      });
      if (res.ok) {
        const indicator = document.getElementById('flash-saved');
        indicator?.classList.add('show');
        setTimeout(() => indicator?.classList.remove('show'), 2000);
      }
    });
  </script>
</AdminLayout>
