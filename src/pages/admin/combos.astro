---
import AdminLayout from '../../layouts/AdminLayout.astro';
import { getAllCombos } from '../../lib/db';

const runtime = (Astro.locals as any).runtime;
const db = runtime?.env?.DB as D1Database;

const combos = await getAllCombos(db);
---

<AdminLayout title="Combos Destacados" activeSection="combos">
  <div class="mb-6">
    <h1 class="text-2xl font-heading font-bold">Combos Destacados</h1>
    <p class="text-text-muted text-sm mt-1">Los 3 combos principales que aparecen en la sección destacada</p>
  </div>

  <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
    {combos.map(combo => (
      <div class="admin-card p-5" data-combo-id={combo.id}>
        <div class="flex items-center justify-between mb-3">
          <span class="text-xs px-2 py-0.5 rounded bg-primary/15 text-primary font-medium">{combo.badge}</span>
          <div class={`admin-toggle ${combo.visible ? 'active' : ''}`}
               data-toggle-combo={combo.id}
               data-visible={combo.visible}></div>
        </div>
        <h3 class="font-bold text-lg mb-1">{combo.name}</h3>
        <p class="text-text-muted text-xs mb-1">{combo.pieces}</p>
        <p class="text-text-secondary text-xs mb-4 line-clamp-2">{combo.description}</p>

        <div class="flex items-center gap-2 mb-3">
          <span class="text-text-muted text-sm">$</span>
          <input type="number" class="admin-input price-input w-24 text-sm py-1.5 px-2"
                 value={combo.price_usd}
                 data-price-combo={combo.id}
                 min="0" max="9999" step="0.01" />
        </div>

        <button class="admin-btn admin-btn-secondary w-full text-xs"
                data-edit-combo={combo.id}
                data-combo-json={JSON.stringify(combo)}>
          Editar detalles
        </button>
        <span class="save-indicator text-xs mt-1 block" data-save-combo={combo.id}>Guardado</span>
      </div>
    ))}
  </div>

  <!-- Edit Modal -->
  <div id="combo-modal" class="admin-modal-backdrop hidden">
    <div class="admin-modal p-6">
      <div class="flex items-center justify-between mb-5">
        <h3 class="font-heading font-bold text-lg">Editar Combo</h3>
        <button id="combo-modal-close" class="p-2 rounded-lg hover:bg-white/5 text-text-muted">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <form id="combo-form" class="space-y-4">
        <input type="hidden" id="cf-id" />
        <div>
          <label class="block text-text-secondary text-xs font-medium mb-1.5">Nombre</label>
          <input type="text" id="cf-name" class="admin-input" maxlength="200" />
        </div>
        <div>
          <label class="block text-text-secondary text-xs font-medium mb-1.5">Piezas</label>
          <input type="text" id="cf-pieces" class="admin-input" maxlength="100" placeholder="Ej: 4 piezas" />
        </div>
        <div>
          <label class="block text-text-secondary text-xs font-medium mb-1.5">Descripción</label>
          <textarea id="cf-desc" class="admin-input" rows="2" maxlength="500"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-text-secondary text-xs font-medium mb-1.5">Precio USD</label>
            <input type="number" id="cf-price" class="admin-input" min="0" max="9999" step="0.01" />
          </div>
          <div>
            <label class="block text-text-secondary text-xs font-medium mb-1.5">Badge</label>
            <input type="text" id="cf-badge" class="admin-input" maxlength="50" />
          </div>
        </div>
        <div class="flex gap-3 pt-2">
          <button type="submit" class="admin-btn admin-btn-primary flex-1">Guardar</button>
          <button type="button" id="combo-modal-cancel" class="admin-btn admin-btn-secondary">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Inline price edit
    document.querySelectorAll('[data-price-combo]').forEach(input => {
      let timeout: any;
      input.addEventListener('input', () => {
        clearTimeout(timeout);
        timeout = setTimeout(async () => {
          const comboId = input.getAttribute('data-price-combo');
          const price = parseFloat((input as HTMLInputElement).value);
          if (isNaN(price) || price < 0) return;

          const res = await fetch(`/api/admin/combos/${comboId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ price_usd: price }),
          });

          if (res.ok) {
            const indicator = document.querySelector(`[data-save-combo="${comboId}"]`);
            if (indicator) {
              indicator.classList.add('show');
              setTimeout(() => indicator.classList.remove('show'), 2000);
            }
          }
        }, 600);
      });
    });

    // Toggle visibility
    document.querySelectorAll('[data-toggle-combo]').forEach(toggle => {
      toggle.addEventListener('click', async () => {
        const comboId = toggle.getAttribute('data-toggle-combo');
        const isVisible = toggle.getAttribute('data-visible') === '1';
        const newVisible = isVisible ? 0 : 1;

        const res = await fetch(`/api/admin/combos/${comboId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ visible: newVisible }),
        });

        if (res.ok) {
          toggle.setAttribute('data-visible', String(newVisible));
          toggle.classList.toggle('active', !!newVisible);
        }
      });
    });

    // Edit modal
    const modal = document.getElementById('combo-modal')!;
    const form = document.getElementById('combo-form') as HTMLFormElement;

    function closeModal() { modal.classList.add('hidden'); }
    document.getElementById('combo-modal-close')?.addEventListener('click', closeModal);
    document.getElementById('combo-modal-cancel')?.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

    document.querySelectorAll('[data-edit-combo]').forEach(btn => {
      btn.addEventListener('click', () => {
        const data = JSON.parse(btn.getAttribute('data-combo-json') || '{}');
        (document.getElementById('cf-id') as HTMLInputElement).value = data.id;
        (document.getElementById('cf-name') as HTMLInputElement).value = data.name;
        (document.getElementById('cf-pieces') as HTMLInputElement).value = data.pieces || '';
        (document.getElementById('cf-desc') as HTMLTextAreaElement).value = data.description || '';
        (document.getElementById('cf-price') as HTMLInputElement).value = data.price_usd;
        (document.getElementById('cf-badge') as HTMLInputElement).value = data.badge || '';
        modal.classList.remove('hidden');
      });
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = (document.getElementById('cf-id') as HTMLInputElement).value;
      const res = await fetch(`/api/admin/combos/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: (document.getElementById('cf-name') as HTMLInputElement).value.trim(),
          pieces: (document.getElementById('cf-pieces') as HTMLInputElement).value.trim(),
          description: (document.getElementById('cf-desc') as HTMLTextAreaElement).value.trim(),
          price_usd: parseFloat((document.getElementById('cf-price') as HTMLInputElement).value),
          badge: (document.getElementById('cf-badge') as HTMLInputElement).value.trim(),
        }),
      });
      if (res.ok) { closeModal(); location.reload(); }
    });
  </script>
</AdminLayout>
